// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright 2022 NXP
 * Copyright 2024 Dynamic Devices Ltd
 * 
 * Device tree for Dynamic Devices i.MX93 Jaguar E-Ink board
 * Features:
 * - ublox MAYA W2 module (IW612 chipset) for WiFi/BT/802.15.4
 * - LTE modem support
 * - Power management via MCXC143VFM microcontroller
 */

/dts-v1/;

#include <dt-bindings/usb/pd.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include "freescale/imx93.dtsi"

&ele_fw2 {
	memory-region = <&ele_reserved>;
};

/ {
	model = "i.MX93 Jaguar E-Ink board";
	compatible = "fsl,imx93-11x11-evk", "fsl,imx93";

	chosen {
		stdout-path = &lpuart1;
	};

	reserved-memory {
		#address-cells = <2>;
		#size-cells = <2>;
		ranges;

		linux,cma {
			compatible = "shared-dma-pool";
			reusable;
			alloc-ranges = <0 0x80000000 0 0x40000000>;
			size = <0 0x10000000>;
			linux,cma-default;
		};

		ethosu_mem: ethosu_region@C0000000 {
			compatible = "shared-dma-pool";
			reusable;
			reg = <0x0 0xC0000000 0x0 0x10000000>;
		};

		ele_reserved: ele-reserved@A4120000 {
			compatible = "shared-dma-pool";
			reg = <0x0 0xA4120000 0x0 0x100000>;
			no-map;
		};

		m33_reserved: m33@a4000000 {
			no-map;
			reg = <0 0xa4000000 0 0x1000000>;
		};

		vdev0vring0: vdev0vring0@a4000000 {
			reg = <0 0xa4000000 0 0x8000>;
			no-map;
		};

		vdev0vring1: vdev0vring1@a4008000 {
			reg = <0 0xa4008000 0 0x8000>;
			no-map;
		};

		vdev1vring0: vdev1vring0@a4010000 {
			reg = <0 0xa4010000 0 0x8000>;
			no-map;
		};

		vdev1vring1: vdev1vring1@a4018000 {
			reg = <0 0xa4018000 0 0x8000>;
			no-map;
		};

		rsc_table: rsc-table@a4020000 {
			reg = <0 0xa4020000 0 0x1000>;
			no-map;
		};

		vdevbuffer: vdevbuffer@a4021000 {
			compatible = "shared-dma-pool";
			reg = <0 0xa4021000 0 0x100000>;
			no-map;
		};
	};

	/* WiFi SDIO power sequence */
	wifi_pwrseq: wifi-pwrseq {
		compatible = "mmc-pwrseq-simple";
		pinctrl-names = "default";
		reset-gpios = <&gpio4 26 GPIO_ACTIVE_LOW>; /* WLAN_RST */
		post-power-on-delay-ms = <200>;
	};

	/* Regulators */
	reg_wifi_vmmc: regulator-wifi-vmmc {
		compatible = "regulator-fixed";
		regulator-name = "VSD_3V3";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		gpio = <&gpio4 26 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		startup-delay-us = <100>;
	};

	/* GPIO keys - temporarily disabled to debug shutdown issue */
	/* gpio-keys {
		compatible = "gpio-keys";
		autorepeat;

		power {
			label = "Power Button";
			gpios = <&gpio3 11 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_POWER>;
			wakeup-source;
			debounce-interval = <10>;
		};
	}; */
};

&cm33 {
	mbox-names = "tx", "rx", "rxdb";
	mboxes = <&mu1 0 1>,
		 <&mu1 1 1>,
		 <&mu1 3 1>;
	memory-region = <&vdevbuffer>, <&vdev0vring0>, <&vdev0vring1>,
			<&vdev1vring0>, <&vdev1vring1>, <&rsc_table>;
	fsl,startup-delay-ms = <500>;
	status = "okay";
};

&mu1 {
	status = "okay";
};

&mu2 {
	status = "okay";
};

/* Console UART */
&lpuart1 {
	status = "okay";
};

/* Pin configuration for LPUART5 Bluetooth */
&iomuxc {
	pinctrl_lpuart5: lpuart5grp {
		fsl,pins = <
			MX93_PAD_DAP_TDO_TRACESWO__LPUART5_TX	0x31e  /* BT UART RX - Output from iMX93 */
			MX93_PAD_DAP_TDI__LPUART5_RX		0x31e  /* BT UART TX - Input to iMX93 */
			MX93_PAD_DAP_TCLK_SWCLK__LPUART5_CTS_B	0x31e  /* BT UART CTS - Output from iMX93 */
			MX93_PAD_DAP_TMS_SWDIO__LPUART5_RTS_B	0x31e  /* BT UART RTS - Input to iMX93 */
		>;
	};

	pinctrl_bluetooth_gpio: bluetooth_gpio_grp {
		fsl,pins = <
			MX93_PAD_ENET2_RD0__GPIO4_IO24		0x31e  /* BT_RST - Active Low, controlled by MCXC143VFM */
		>;
	};
};

/* Bluetooth UART - ublox MAYA W2 - LPUART5 is at 42590000 on iMX93 */
&lpuart4 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpuart5>;  /* Still using LPUART5 pin config (DAP pins) */
	fsl,uart-has-rtscts;  /* Enable RTS/CTS hardware flow control */
	status = "okay";

	bluetooth {
		compatible = "nxp,88w8997-bt";
		fw-init-baudrate = <3000000>;
	};
};

/* WiFi SDIO Interface - ublox MAYA W2 (IW612) */
&usdhc2 {
	vmmc-supply = <&reg_wifi_vmmc>;
	mmc-pwrseq = <&wifi_pwrseq>;
	bus-width = <4>;
	keep-power-in-suspend;
	non-removable;
	wakeup-source;
	max-frequency = <100000000>;
	fsl,sdio-async-interrupt-enabled;
	pm-ignore-notify;
	cap-power-off-card;
	status = "okay";

	wifi_wake_host {
		compatible = "nxp,wifi-wake-host";
		interrupt-parent = <&gpio4>;
		interrupts = <25 IRQ_TYPE_LEVEL_LOW>;  /* ENET2_RD1 - SD2_INT */
		interrupt-names = "host-wake";
		wakeup-source;
	};
};

/* eMMC storage */
&usdhc1 {
	bus-width = <8>;
	non-removable;
	keep-power-in-suspend;
	status = "okay";
};

/* SPI Interface disabled - no longer needed */
&lpspi3 {
	status = "disabled";
};

&wdog3 {
	status = "okay";
	timeout-sec = <40>;
};
