// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright 2022 NXP
 * Copyright 2024 Dynamic Devices Ltd
 * 
 * Device tree for Dynamic Devices i.MX93 Jaguar E-Ink board
 * 
 * ============================================================================
 * CRITICAL FIXES APPLIED - DO NOT REVERT WITHOUT UNDERSTANDING
 * ============================================================================
 * 
 * 1. BBNSM IRQ CONFLICT RESOLUTION:
 *    - BBNSM RTC disabled (using external PCF2131 for 166x power savings)
 *    - BBNSM power key disabled (no physical button on board)
 *    - Prevents: genirq: Flags mismatch irq 20 / bbnsm_rtc failed to request irq
 * 
 * 2. LPUART7 IRQ FIX:
 *    - Removed custom IRQ override (GIC_SPI 73) that conflicted with BBNSM
 *    - Now uses correct default IRQ (GIC_SPI 210 = Linux IRQ 242)
 *    - Prevents: GPIO device link failures and UART conflicts
 * 
 * 3. BLUETOOTH MAYA W2 LPUART FIX:
 *    - Moved from LPUART5 to LPUART2 to match actual hardware configuration
 *    - Fixes: "Bluetooth: hci0: Opcode 0x0c03 failed: -110" (HCI Reset timeout)
 *    - Root cause: Base DT has bluetooth on LPUART2, our overlay had LPUART5
 *    - btnxpuart driver now binds correctly to hardware on LPUART2
 * 
 * 4. LPSPI2 DMA ERROR FIX:
 *    - Explicitly disabled unused LPSPI2 to prevent DMA setup errors
 *    - Prevents: "fsl_lpspi 44360000.spi: dma setup error -19, use pio"
 * 
 * 5. POWER OPTIMIZATION:
 *    - Primary RTC: PCF2131 (I2C3, 600nA, wake capability)
 *    - Internal RTC: DISABLED (100µA too high for 5-year battery life)
 *    - PMU RTC: MCXC143VFM (always powered, system management)
 * 
 * Features:
 * - ublox MAYA W2 module (IW612 chipset) for WiFi/BT/802.15.4
 * - LTE modem support
 * - Power management via MCXC143VFM microcontroller
 * - E-Ink display interfaces (SPI primary, QSPI disabled)
 * - 5-year battery life optimization
 * ============================================================================
 */

/dts-v1/;

#include <dt-bindings/input/input.h>
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include "freescale/imx93.dtsi"

/* EdgeLock Enclave enabled on E-Ink board for secure functionality */

/ {
	model = "i.MX93 Jaguar E-Ink board";
    compatible = "fsl,imx93-jaguar-eink", "fsl,imx93-11x11-evk", "fsl,imx93";

	chosen {
		stdout-path = &lpuart1;
	};

	/* Serial port aliases - explicit mapping to prevent out-of-range errors */
	aliases {
		serial0 = &lpuart1;  /* Console UART */
		serial1 = &lpuart2;  /* Bluetooth UART - MAYA W2 */
		serial2 = &lpuart7;  /* Power Management UART - MCXC143VFM PMU */
		/* Explicitly disable unused LPUARTs to prevent conflicts */
		serial3 = &lpuart3;  /* Unused */
		serial4 = &lpuart4;  /* Unused */
		serial5 = &lpuart5;  /* Unused */
		serial6 = &lpuart6;  /* Unused */
		serial7 = &lpuart8;  /* Unused */
	};

	/* LMP Bootloader node - required by Foundries.io LMP */
	bootloader {
		compatible = "lmp,bootloader";
	};

	reserved-memory {
		#address-cells = <2>;
		#size-cells = <2>;
		ranges;

		linux,cma {
			compatible = "shared-dma-pool";
			reusable;
			alloc-ranges = <0 0x80000000 0 0x40000000>;
			size = <0 0x10000000>;
			linux,cma-default;
		};

		ethosu_mem: ethosu_region@C0000000 {
			compatible = "shared-dma-pool";
			reusable;
			reg = <0x0 0xC0000000 0x0 0x10000000>;
		};

		/* EdgeLock Enclave reserved memory region */
		ele_reserved: ele-reserved@90000000 {
			compatible = "shared-dma-pool";
			reg = <0 0x90000000 0 0x100000>;
			no-map;
		};

		/* Cortex-M33 reserved memory regions */
		rsc_table: rsc-table@1fff8000 {
			reg = <0 0x1fff8000 0 0x1000>;
			no-map;
		};

		vdev0vring0: vdev0vring0@aff00000 {
			reg = <0 0xaff00000 0 0x8000>;
			no-map;
		};

		vdev0vring1: vdev0vring1@aff08000 {
			reg = <0 0xaff08000 0 0x8000>;
			no-map;
		};

		vdev1vring0: vdev1vring0@aff10000 {
			reg = <0 0xaff10000 0 0x8000>;
			no-map;
		};

		vdev1vring1: vdev1vring1@aff18000 {
			reg = <0 0xaff18000 0 0x8000>;
			no-map;
		};

		vdevbuffer: vdevbuffer@a8400000 {
			compatible = "shared-dma-pool";
			reg = <0 0xa8400000 0 0x100000>;
			no-map;
		};

		m33_reserved: m33_noncacheable_section@a8600000 {
			no-map;
			reg = <0 0xa8600000 0 0x1000000>;
		};
	};

	/* WiFi SDIO power sequence */
	wifi_pwrseq: wifi-pwrseq {
		compatible = "mmc-pwrseq-simple";
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_wifi_gpio>;
		reset-gpios = <&gpio4 26 GPIO_ACTIVE_LOW>; /* WLAN_RST */
		post-power-on-delay-ms = <500>; /* Increased for proper reset */
		power-off-delay-us = <50000>; /* Increased to 50ms for proper reset */
	};

	/* Regulators */
	reg_wifi_vmmc: regulator-wifi-vmmc {
		compatible = "regulator-fixed";
		regulator-name = "VSD_3V3";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		/* WiFi power is controlled by MCXC143VFM, not directly by i.MX93 GPIO */
		regulator-always-on;
		startup-delay-us = <100>;
	};

};

/* Cortex-M33 support - TODO: Add proper CM33 node definition for i.MX93 */
/* Removed &cm33 reference as it doesn't exist in i.MX93 base device tree */

/* EdgeLock Enclave Message Unit - required for secure functionality */
&s4muap {
	status = "okay";
};

&mu1 {
	status = "okay";
};

&mu2 {
	status = "okay";
};

/* EdgeLock Enclave Message Unit - required for secure functionality */
&s4muap {
	status = "okay";
};

&mu1 {
	status = "okay";
};

&mu2 {
	status = "okay";
};

/* ============================================================================
 * BBNSM (Battery-Backed Security Module) Configuration - POWER OPTIMIZED
 * ============================================================================
 * 
 * CRITICAL IRQ CONFLICT RESOLUTION:
 * The base i.MX93 device tree defines both bbnsm_rtc and bbnsm_pwrkey using
 * the SAME IRQ (GIC_SPI 73 = Linux IRQ 105). This causes boot failures:
 * 
 * ERROR: genirq: Flags mismatch irq 20. 00000084 (rtc alarm) vs. 00000004 (fsl-lpuart)
 * ERROR: bbnsm_rtc 44440000.bbnsm:rtc: failed to request irq 20: -16
 * 
 * SOLUTION: Disable both BBNSM devices since:
 * 1. No physical power button exists on this board
 * 2. External PCF2131 RTC is 166x more power efficient (600nA vs 100µA)
 * 
 * POWER ARCHITECTURE:
 * - Internal BBNSM RTC: ~100µA (DISABLED - too high for 5-year battery life)
 * - External PCF2131 RTC: 600nA (PRIMARY - ultra-low power, I2C3 @ 0x53)
 * - MCXC143VFM PMU RTC: Always powered (internal to power management micro)
 * ============================================================================ */

&bbnsm_pwrkey {
	status = "disabled";  /* No physical power button on this board */
};

&bbnsm_rtc {
	status = "disabled";  /* Using external PCF2131 for 166x better power efficiency */
};


/* Console UART */
&lpuart1 {
	status = "okay";
};

/* Unused UARTs - explicitly disable to prevent GPIO conflicts and device link failures */
&lpuart2 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpuart2 &pinctrl_bluetooth_gpio>;
	/* MAYA W2 Bluetooth configuration - higher baudrate required
	 * Hardware flow control disabled to prevent timeout issues
	 * Fixes: "Bluetooth: hci0: Setting wake-up method failed (-110)"
	 * Reference: MAYA W2 needs 3MHz baudrate for proper initialization
	 */
	/* fsl,uart-has-rtscts; -- DISABLED for MAYA W2 compatibility */
	status = "okay";  /* Bluetooth UART - MAYA W2 */

	bluetooth {
		compatible = "nxp,88w8997-bt";
		fw-init-baudrate = <3000000>;  /* Higher baudrate for MAYA W2 - 115200 was causing timeout errors */
		reset-gpios = <&gpio4 24 GPIO_ACTIVE_LOW>;  /* BT_RST - MX93_PAD_ENET2_RD0__GPIO4_IO24 */
	};
};

&lpuart3 {
	status = "disabled";  /* Unused */
	/* Disable power management to prevent device link failures during boot */
	/delete-property/ power-domains;
};

&lpuart4 {
	status = "disabled";  /* Unused */
	/* Disable power management to prevent device link failures during boot */
	/delete-property/ power-domains;
};

&lpuart6 {
	status = "disabled";  /* Unused */
	/* Disable power management to prevent device link failures during boot */
	/delete-property/ power-domains;
};

&lpuart8 {
	status = "disabled";  /* Unused */
	/* Disable power management to prevent device link failures during boot */
	/delete-property/ power-domains;
};

/* Pin configuration for LPUART2 Bluetooth */
&iomuxc {
	/* Pin configuration for LPUART2 Bluetooth - MAYA W2 without flow control */
	pinctrl_lpuart2: lpuart2grp {
		fsl,pins = <
			MX93_PAD_UART2_TXD__LPUART2_TX		0x31e  /* BT UART TX - Output from iMX93 */
			MX93_PAD_UART2_RXD__LPUART2_RX		0x31e  /* BT UART RX - Input to iMX93 */
			/* RTS/CTS pins removed - MAYA W2 doesn't support hardware flow control reliably
			 * Hardware flow control disabled to prevent timeout issues
			 */
		>;
	};

	pinctrl_bluetooth_gpio: bluetooth_gpio_grp {
		fsl,pins = <
			MX93_PAD_ENET2_RD0__GPIO4_IO24		0x31e  /* BT_RST - Active Low, Software Reset for BT & 802.15.4 */
		>;
	};

	/* LPUART7 pinctrl for MCXC143VFM power management microcontroller */
	pinctrl_lpuart7: lpuart7grp {
		fsl,pins = <
			MX93_PAD_GPIO_IO08__LPUART7_TX		0x31e  /* TX to MCXC143VFM power management micro */
			MX93_PAD_GPIO_IO09__LPUART7_RX		0x31e  /* RX from MCXC143VFM power management micro */
		>;
	};

	/* WiFi GPIO pin configuration */
	pinctrl_wifi_gpio: wifi_gpio_grp {
		fsl,pins = <
			MX93_PAD_ENET2_RD2__GPIO4_IO26		0x31e  /* WLAN_RST - WiFi Reset (Active-Low) */
		>;
	};

	/* FlexSPI1 (QSPI) pin configuration for E-Ink display - Primary Option */
	pinctrl_flexspi1: flexspi1grp {
		fsl,pins = <
			MX93_PAD_SD3_CLK__FLEXSPI1_A_SCLK	0x31e  /* QSPI Clock */
			MX93_PAD_SD3_CMD__FLEXSPI1_A_SS0_B	0x31e  /* QSPI CS0 */
			MX93_PAD_SD3_DATA0__FLEXSPI1_A_DATA00	0x31e  /* QSPI Data 0 */
			MX93_PAD_SD3_DATA1__FLEXSPI1_A_DATA01	0x31e  /* QSPI Data 1 */
			MX93_PAD_SD3_DATA2__FLEXSPI1_A_DATA02	0x31e  /* QSPI Data 2 */
			MX93_PAD_SD3_DATA3__FLEXSPI1_A_DATA03	0x31e  /* QSPI Data 3 */
		>;
	};

	/* SPI1 pin configuration for E-Ink display - Backup Option */
	pinctrl_lpspi1: lpspi1grp {
		fsl,pins = <
			MX93_PAD_SAI1_TXC__LPSPI1_SIN		0x31e  /* MISO */
			MX93_PAD_SAI1_RXD0__LPSPI1_SOUT		0x31e  /* MOSI */
			MX93_PAD_SAI1_TXD0__LPSPI1_SCK		0x31e  /* SCK */
		>;
	};

	/* SPI3 pin configuration - NOT USED on this board */
	/* 802.15.4 interface not implemented - pins needed for LPUART7 power management */
	/*
	pinctrl_lpspi3: lpspi3grp {
		fsl,pins = <
			MX93_PAD_GPIO_IO09__LPSPI3_SIN		0x31e  // MOSI - conflicts with LPUART7_RX
			MX93_PAD_GPIO_IO10__LPSPI3_SOUT		0x31e  // MISO
			MX93_PAD_GPIO_IO11__LPSPI3_SCK		0x31e  // SCK
			MX93_PAD_GPIO_IO08__LPSPI3_PCS0		0x31e  // CS0 - conflicts with LPUART7_TX
			MX93_PAD_ENET2_RD3__GPIO4_IO27		0x31e  // ZB_INT - 802.15.4 Interrupt
		>;
	};
	*/

	/* E-Ink display GPIO pins
	 * 
	 * CRITICAL: i.MX93 GPIO CHIP MAPPING (NON-LOGICAL ORDER!)
	 * =====================================================
	 * gpiochip0: GPIOs 512-543 = GPIO2 (platform/43810000)
	 * gpiochip1: GPIOs 544-575 = GPIO3 (platform/43820000)  
	 * gpiochip2: GPIOs 576-607 = GPIO4 (platform/43830000)
	 * gpiochip3: GPIOs 608-639 = GPIO1 (platform/47400000)
	 *
	 * GPIO Calculation Formula:
	 * GPIO1_IOx = 608 + x  (gpiochip3)
	 * GPIO2_IOx = 512 + x  (gpiochip0)
	 * GPIO3_IOx = 544 + x  (gpiochip1)
	 * GPIO4_IOx = 576 + x  (gpiochip2)
	 *
	 * E-Ink Control Signals (Hardware-Verified):
	 *   - RES_DIS# (GPIO 526): GPIO2_IO14 = 512+14 = 526 - Reset (Active-Low)
	 *   - D/C#_DIS (GPIO 527): GPIO2_IO15 = 512+15 = 527 - Data/Command (LO=Cmd, HI=Data)
	 *   - L#R_SEL_DIS (GPIO 528): GPIO2_IO16 = 512+16 = 528 - Chip Select Routing (LO=Left, HI=Right)
	 *   - BUSY_DIS# (GPIO 529): GPIO2_IO17 = 512+17 = 529 - Busy Status (LO=Busy, Input)
	 *   - CS1 (GPIO 619): GPIO1_IO11 = 608+11 = 619 - Chip Select 1 (Right half)
	 *   - NO POWER ENABLE GPIO (power managed by MCXC143VFM microcontroller)
	 */
	pinctrl_eink_gpio: eink_gpio_grp {
		fsl,pins = <
			MX93_PAD_GPIO_IO14__GPIO2_IO14		0x31e  /* RES_DIS# - Reset (Active-Low) - GPIO 526 */
			MX93_PAD_GPIO_IO15__GPIO2_IO15		0x31e  /* D/C#_DIS - Data/Command (LO=Cmd, HI=Data) - GPIO 527 */
			MX93_PAD_GPIO_IO16__GPIO2_IO16		0x31e  /* L#R_SEL_DIS - Chip Select Routing (LO=Left, HI=Right) - GPIO 528 */
			MX93_PAD_GPIO_IO17__GPIO2_IO17		0x31e  /* CS0 - Chip Select 0 (Left half) - GPIO 529 */
			MX93_PAD_SAI1_TXFS__GPIO1_IO11		0x31e  /* CS1 - Chip Select 1 (Right half) - GPIO 619 */
		>;
	};

	/* I2C2 pinctrl for PCA9451A PMIC */
	pinctrl_lpi2c2: lpi2c2grp {
		fsl,pins = <
			MX93_PAD_I2C2_SCL__LPI2C2_SCL		0x40000b9e  /* I2C2_SCL */
			MX93_PAD_I2C2_SDA__LPI2C2_SDA		0x40000b9e  /* I2C2_SDA */
		>;
	};

	/* I2C3 pinctrl for PCF2131 RTC - confirmed by schematic */
	pinctrl_lpi2c3: lpi2c3grp {
		fsl,pins = <
			MX93_PAD_GPIO_IO28__LPI2C3_SDA		0x40000b9e  /* I2C3_SDA */
			MX93_PAD_GPIO_IO29__LPI2C3_SCL		0x40000b9e  /* I2C3_SCL */
		>;
	};

	/* PCF2131 RTC interrupt pin configuration */
	pinctrl_pcf2131_irq: pcf2131_irq_grp {
		fsl,pins = <
			MX93_PAD_ENET2_RX_CTL__GPIO4_IO22	0x31e  /* PCF2131 INTA# - Wake interrupt */
		>;
	};

};

&lpuart5 {
	status = "disabled";  /* Unused - Bluetooth moved to LPUART2 to match hardware */
	/* Disable power management to prevent device link failures during boot */
	/delete-property/ power-domains;
};

/* ============================================================================
 * Power Control Microcontroller UART - MCXC143VFM - LPUART7
 * ============================================================================
 * 
 * CRITICAL IRQ FIX - CUSTOM IRQ OVERRIDE REMOVED:
 * Previous incorrect configuration had:
 *   interrupts = <GIC_SPI 73 IRQ_TYPE_LEVEL_HIGH>;  // WRONG - conflicts with BBNSM
 * 
 * This caused IRQ conflicts because GIC_SPI 73 (Linux IRQ 105) was already
 * used by BBNSM RTC and BBNSM power key, leading to boot failures.
 * 
 * CORRECT CONFIGURATION:
 * Now uses default IRQ from base i.MX93 device tree:
 *   - LPUART7 @ 0x42690000: GIC_SPI 210 (Linux IRQ 242)
 *   - No conflicts with other devices
 * 
 * HARDWARE DETAILS:
 * - Address: 0x42690000 (LPUART7)
 * - IRQ: GIC_SPI 210 (Linux IRQ 242) - from base imx93.dtsi
 * - Device: /dev/ttyLP2 (serial2 alias)
 * - Pins: MX93_PAD_GPIO_IO08 (TX), MX93_PAD_GPIO_IO09 (RX)
 * - Baudrate: 115200 (default)
 * 
 * MCXC143VFM FUNCTIONS:
 * - WiFi/BT power control and sequencing
 * - Battery monitoring and fuel gauge
 * - System power management and wake scheduling  
 * - 5-year battery life optimization algorithms
 * ============================================================================ */
&lpuart7 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpuart7>;
	/* Use default IRQ assignment from base i.MX93 device tree (GIC_SPI 210 = IRQ 242) */
	/* Previous custom override (GIC_SPI 73) was causing IRQ conflicts with BBNSM */
	status = "okay";
	
	/* TEMPORARY WORKAROUND FOR TESTING: Disable runtime power management for MCXC143VFM communication */
	/* This prevents the UART from going into suspend mode which breaks PMU communication */
	/* TODO: Find a more elegant solution that allows power management while maintaining communication */
	/delete-property/ power-domains;
	
	/* No child device node - MCXC143VFM controlled via userspace application */
};

/* WiFi SDIO Interface - ublox MAYA W2 (IW612) */
&usdhc2 {
	vmmc-supply = <&reg_wifi_vmmc>;
	mmc-pwrseq = <&wifi_pwrseq>;
	bus-width = <4>;
	keep-power-in-suspend;
	non-removable;
	wakeup-source;
	max-frequency = <100000000>;
	fsl,sdio-async-interrupt-enabled;
	pm-ignore-notify;
	cap-power-off-card;
	status = "okay";

	wifi_wake_host {
		compatible = "nxp,wifi-wake-host";
		interrupt-parent = <&gpio4>;
		interrupts = <25 IRQ_TYPE_LEVEL_LOW>;  /* ENET2_RD1 - SD2_INT */
		interrupt-names = "host-wake";
		wakeup-source;
	};
};

/* eMMC storage */
&usdhc1 {
	bus-width = <8>;
	non-removable;
	keep-power-in-suspend;
	status = "okay";
};

/*
 * E-Ink Display SPI Configuration - Spectra 6 EL133UF1
 * 
 * Both QSPI and regular SPI interfaces are enabled by default for maximum flexibility:
 * 
 * FlexSPI1 (QSPI) - Primary Option:
 *   - Device: /dev/spidev0.0
 *   - Speed: Up to 80 MHz
 *   - 4-bit data width (quad mode)
 *   - Uses SD3 pins (SD3_CLK, SD3_CMD, SD3_DATA0-3)
 *   - Compatible: "spectra6,el133uf1-qspi", "spidev" (fallback for testing)
 * 
 * LPSPI1 (Regular SPI) - Backup/Alternative Option:
 *   - Device: /dev/spidev1.0  
 *   - Speed: Up to 10 MHz (conservative)
 *   - 1-bit data width (standard SPI)
 *   - Uses SAI1 pins (SAI1_TXC, SAI1_RXD0, SAI1_TXD0, SAI1_TXFS)
 *   - Compatible: "spectra6,el133uf1-spi", "spidev" (fallback for testing)
 * 
 * Both interfaces share the same GPIO control pins (reset, busy, dc) and power supply.
 * The spidev fallback compatible string enables /dev/spidev* devices for testing
 * and development while preserving the ability to load custom E-Ink drivers.
 */

/* QSPI Interface for E-Ink Display - DISABLED (FlexSPI doesn't support spidev) */
&flexspi1 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_flexspi1>;
	status = "disabled"; /* FlexSPI uses MTD subsystem, not spidev */

	eink_display: flash@0 {
		compatible = "rohm,dh2228fv";
		reg = <0>;
		spi-max-frequency = <80000000>; /* 80 MHz - QSPI can handle higher speeds */
		spi-tx-bus-width = <4>; /* Quad SPI - 4 data lines for TX */
		spi-rx-bus-width = <4>; /* Quad SPI - 4 data lines for RX */
		
		/* GPIO control pins for E-Ink display - pinctrl only (allows userspace access) */
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_eink_gpio>;
		
		
		status = "disabled"; /* FlexSPI uses MTD subsystem, not spidev */
	};
};

/* Standard SPI Interface for E-Ink Display - PRIMARY for testing */
&lpspi1 {
	#address-cells = <1>;
	#size-cells = <0>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpspi1>;
	/* Add DMA channels for better performance and eliminate DMA probe errors */
	dmas = <&edma1 0 14>, <&edma1 0 15>;
	dma-names = "tx", "rx";
	status = "okay"; /* Primary interface for standard SPI testing */

	eink_display_spi: eink@0 {
		compatible = "rohm,dh2228fv";
		reg = <0>;
		spi-max-frequency = <10000000>; /* 10 MHz - conservative for regular SPI */
		spi-cpha;
		spi-cpol;
		
		/* GPIO control pins for E-Ink display - pinctrl only (allows userspace access) */
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_eink_gpio>;
		
		
		status = "okay";
	};
};

/* ============================================================================
 * LPSPI2 - DISABLED (DMA Error Fix)
 * ============================================================================
 * 
 * HARDWARE: Not used on this board (address 0x44360000)
 * 
 * DMA ERROR FIX:
 * Previous boot error: "fsl_lpspi 44360000.spi: dma setup error -19, use pio"
 * 
 * ROOT CAUSE: LPSPI2 was trying to set up DMA channels but:
 * 1. No DMA channels assigned in device tree
 * 2. Hardware not connected on this board
 * 3. Driver still attempts DMA setup during probe
 * 
 * SOLUTION: Explicitly disable to prevent DMA probe errors and reduce power
 * ============================================================================ */
&lpspi2 {
	status = "disabled";
};

/*
 * 802.15.4 SPI Interface - NOT IMPLEMENTED on this board
 * 
 * The ublox MAYA W2 module does not provide 802.15.4 functionality on this board.
 * GPIO_IO08 and GPIO_IO09 are needed for LPUART7 (MCXC143VFM power management).
 * 
 * Original planned configuration (not used):
 *   - Device: /dev/spidev2.0
 *   - Speed: Up to 12 MHz
 *   - Uses GPIO pins (GPIO_IO08-11) for SPI signals
 *   - Interrupt: GPIO4_IO27 (ENET2_RD3)
 */
&lpspi3 {
	status = "disabled";
};

/* ============================================================================
 * EDMA1 DMA Controller - Enable for LPSPI1 DMA support
 * ============================================================================
 * 
 * PROBLEM: LPSPI1 DMA setup error -19 (ENODEV)
 * ERROR: "fsl_lpspi 44360000.spi: dma setup error -19, use pio"
 * 
 * ROOT CAUSE: EDMA1 controller not explicitly enabled in device tree
 * - LPSPI1 requests: dmas = <&edma1 0 14>, <&edma1 0 15>
 * - EDMA1 exists at 44000000.dma-controller but may be disabled by default
 * - Error sequence: -517 (EPROBE_DEFER) → -19 (ENODEV) → PIO fallback
 * 
 * SOLUTION: Explicitly enable EDMA1 controller
 * - Ensures DMA channels are available for LPSPI1
 * - Eliminates boot error and improves SPI performance
 * - DMA channels 14 and 15 verified available (in_use: 0)
 * ============================================================================ */
&edma1 {
	status = "okay";
};

/*
 * USB-C port (usbotg1) - board lacks Type-C/PD controller so operate in forced host mode.
 * No external VBUS regulator control needed - hardware provides fixed 5V.
 */
&usbotg1 {
	dr_mode = "host";
	hnp-disable;
	srp-disable;
	adp-disable;
	disable-over-current;
	status = "okay";
};


/* ============================================================================
 * I2C3 Interface for PCF2131 RTC - PRIMARY RTC FOR 5-YEAR BATTERY LIFE
 * ============================================================================
 * 
 * SCHEMATIC CONFIRMED: PCF2131 connects to I2C3_SDA/SCL via GPIO_IO28/29
 * 
 * POWER-OPTIMIZED RTC ARCHITECTURE:
 * - Internal i.MX93 BBNSM RTC: ~100µA (DISABLED - too high for 5-year battery)
 * - External PCF2131 RTC: 600nA (PRIMARY - 166x more efficient!)
 * - MCXC143VFM PMU RTC: Always powered (internal to PMU)
 * 
 * HARDWARE CONNECTIONS (per schematic):
 * - I2C3_SDA: GPIO_IO28 (pin J21) → PCF2131 pin 5
 * - I2C3_SCL: GPIO_IO29 (pin J20) → PCF2131 pin 4
 * - INTA#: GPIO4_IO22 → i.MX93 wake interrupt
 * - INTB#: Connected to MCXC143VFM PMU
 * ============================================================================ */
&lpi2c3 {
	#address-cells = <1>;
	#size-cells = <0>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpi2c3>;
	status = "okay";
	clock-frequency = <100000>;  /* 100kHz for low power operation */
	
	/* Ensure clocks are properly assigned and enabled */
	assigned-clocks = <&clk IMX93_CLK_LPI2C3_GATE>;
	assigned-clock-parents = <&clk IMX93_CLK_SYS_PLL_PFD1_DIV2>;
	assigned-clock-rates = <24000000>;

	pcf2131: rtc@53 {
		compatible = "nxp,pcf2131";
		reg = <0x53>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_pcf2131_irq>;
		interrupt-parent = <&gpio4>;
		interrupts = <22 IRQ_TYPE_LEVEL_LOW>; /* GPIO4_IO22 - INTA# */
		interrupt-names = "alarm";
		wakeup-source;                         /* Enable wake capability */
		
		/* POWER OPTIMIZATION: Direct switching mode for lower power consumption */
		nxp,power-mode = <3>;                  /* Direct switching mode (011) */
		
		/* ULTRA-LOW POWER: Disable temperature compensation for minimum current */
		nxp,temp-compensation-disable;
		
		/* BATTERY MANAGEMENT: Optimize for 3.3V VBAT operation */
		nxp,battery-low-detection;
		
		/* WAKE OPTIMIZATION: Configure both interrupt outputs */
		nxp,dual-interrupt-mode;
	};
};

/* 
 * I2C2 Interface for PCA9451A PMIC
 * 
 * Hardware Configuration:
 *   - PCA9451A PMIC connected to i.MX93 LPI2C2  
 *   - I2C Address: 0x25
 *   - SDA: MX93_PAD_I2C2_SDA__LPI2C2_SDA
 *   - SCL: MX93_PAD_I2C2_SCL__LPI2C2_SCL
 *   - Provides power rails for i.MX93 SoC and peripherals
 *   - BUCK1 supplies VDD_SOC for LPM driver
 */
&lpi2c2 {
	#address-cells = <1>;
	#size-cells = <0>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpi2c2>;
	status = "okay";

	pmic: pca9451a@25 {
		compatible = "nxp,pca9451a";
		reg = <0x25>;
		interrupt-parent = <&gpio3>;
		interrupts = <27 IRQ_TYPE_EDGE_FALLING>;

		regulators {
			buck1: BUCK1 {
				regulator-name = "BUCK1";
				regulator-min-microvolt = <650000>;
				regulator-max-microvolt = <2237500>;
				regulator-boot-on;
				regulator-always-on;
				regulator-ramp-delay = <3125>;
			};

			buck2: BUCK2 {
				regulator-name = "BUCK2";
				regulator-min-microvolt = <600000>;
				regulator-max-microvolt = <2187500>;
				regulator-boot-on;
				regulator-always-on;
				regulator-ramp-delay = <3125>;
			};

			buck4: BUCK4 {
				regulator-name = "BUCK4";
				regulator-min-microvolt = <600000>;
				regulator-max-microvolt = <3400000>;
				regulator-boot-on;
				regulator-always-on;
			};

			buck5: BUCK5 {
				regulator-name = "BUCK5";
				regulator-min-microvolt = <600000>;
				regulator-max-microvolt = <3400000>;
				regulator-boot-on;
				regulator-always-on;
			};

			buck6: BUCK6 {
				regulator-name = "BUCK6";
				regulator-min-microvolt = <600000>;
				regulator-max-microvolt = <3400000>;
				regulator-boot-on;
				regulator-always-on;
			};

			ldo1: LDO1 {
				regulator-name = "LDO1";
				regulator-min-microvolt = <1600000>;
				regulator-max-microvolt = <3300000>;
				regulator-boot-on;
				regulator-always-on;
			};

			ldo4: LDO4 {
				regulator-name = "LDO4";
				regulator-min-microvolt = <800000>;
				regulator-max-microvolt = <3300000>;
				regulator-boot-on;
				regulator-always-on;
			};

			ldo5: LDO5 {
				regulator-name = "LDO5";
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <3300000>;
				regulator-boot-on;
				regulator-always-on;
			};
		};
	};
};

/* GPIO pins are available for userspace control via your application */
/* Pinctrl configurations above ensure proper pin muxing to GPIO function */

/* ============================================================================
 * POWER MANAGEMENT CONFIGURATION
 * Critical for 5-year battery life requirement
 * ============================================================================ */

/* i.MX93 Low Power Management (LPM) Driver - CRITICAL FOR CPU FREQUENCY SCALING
 * Enables 4 operating modes:
 * - Mode 0 (OD): 1700 MHz CPU, 3733 MT/s DDR (High Performance)
 * - Mode 1 (ND): 1400 MHz CPU, 1866 MT/s DDR (Balanced)
 * - Mode 2 (LD): 900 MHz CPU, 1866 MT/s DDR (Power Save)
 * - Mode 3 (LD): 900 MHz CPU, 625 MT/s DDR (Maximum Power Save)
 * 
 * Control via: echo 3 > /sys/devices/platform/imx93-lpm/mode
 * Status via: cat /sys/devices/platform/imx93-lpm/mode
 * Clock rate: cat /sys/kernel/debug/clk/a55_core/clk_rate
 * 
 * NOTE: Power management handled by custom MCXC143VFM microcontroller
 * PMIC: Standard PCA9451A provides VDD_SOC regulation via BUCK1
 */
&lpm {
	soc-supply = <&buck1>;	/* CRITICAL: VDD_SOC supply from PMIC BUCK1 */
	ld-mode-enabled;        /* Enable Low Drive modes (2,3) for maximum power savings */
	status = "okay";        /* Enable the driver - CRITICAL */
};

/* ANATOP - Analog power management and voltage regulation */
&anatop {
	status = "okay";
};

&wdog3 {
	status = "okay";
	timeout-sec = <40>;
};

/* ============================================================================
 * EDGELOCK ENCLAVE (ELE) CONFIGURATION - CRITICAL FOR BOOT SUCCESS
 * ============================================================================ */

/* EdgeLock Enclave Memory Unit - CRITICAL FIX for boot hang
 * Links ELE device to its reserved memory region
 * Without this: "fsl-ele-mu soc@0:ele-mu: failed to init reserved memory region -19"
 * Followed by: RCU stall at 21 seconds causing boot failure
 */
&ele_mu {
	memory-region = <&ele_reserved>;
};

/* ============================================================================
 * CORTEX-M33 CONFIGURATION - POWER MANAGEMENT MICROCONTROLLER
 * ============================================================================ */

/* ============================================================================
 * CORTEX-M33 CONFIGURATION - POWER MANAGEMENT MICROCONTROLLER
 * ============================================================================ */

/* i.MX93 Cortex-M33 - MCXC143VFM Power Management Microcontroller
 * 
 * Based on i.MX93 Reference Manual Chapters 13-16:
 * - Chapter 13.1: CM33 has 128KB Code TCM + 128KB System TCM
 * - Memory mapping: Code TCM 0x0FFE_0000, Data TCM 0x2000_0000
 * - System access: 0x201E_0000-0x201F_FFFF (Code), 0x2020_0000-0x2021_FFFF (System)
 * 
 * Configuration pattern from working i.MX8ULP example (&imx8ulp_cm33):
 * - Links M33 device to reserved memory regions
 * - Fixes: "of_reserved_mem_lookup() returned NULL" error
 * - Enables RPMSG communication with MCXC143VFM microcontroller
 * - Memory regions: rsc_table, vdev rings, vdevbuffer, m33_reserved
 * 
 * RPMSG drivers enabled in kernel: cortex-m33-support.cfg
 * Userspace tools: Need to verify remoteproc utilities availability
 */

/* NOTE: Device tree label research needed
 * - i.MX8ULP uses: &imx8ulp_cm33
 * - i.MX93 likely uses: &imx93_cm33 or similar
 * - Need to check i.MX93 base device tree for correct label
 * - Pattern: &<soc>_cm33 { ... }
 */

/* TODO: Uncomment when correct device tree label is confirmed
&imx93_cm33 {
	memory-region = <&vdevbuffer>, <&vdev0vring0>, <&vdev0vring1>, <&rsc_table>;
	rsc-da = <0x1fff8000>;
	mbox-names = "tx", "rx", "rxdb";
	mboxes = <&mu 0 1
		  &mu 1 1
		  &mu 3 1>;
	status = "okay";
};
*/
