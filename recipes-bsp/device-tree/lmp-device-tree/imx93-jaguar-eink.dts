// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright 2022 NXP
 * Copyright 2024 Dynamic Devices Ltd
 * 
 * Device tree for Dynamic Devices i.MX93 Jaguar E-Ink board
 * Features:
 * - ublox MAYA W2 module (IW612 chipset) for WiFi/BT/802.15.4
 * - LTE modem support
 * - Power management via MCXC143VFM microcontroller
 */

/dts-v1/;

#include <dt-bindings/usb/pd.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include "freescale/imx93.dtsi"

/* EdgeLock Enclave enabled on E-Ink board for secure functionality */

/ {
	model = "i.MX93 Jaguar E-Ink board";
    compatible = "fsl,imx93-jaguar-eink", "fsl,imx93-11x11-evk", "fsl,imx93";

	chosen {
		stdout-path = &lpuart1;
	};

	reserved-memory {
		#address-cells = <2>;
		#size-cells = <2>;
		ranges;

		linux,cma {
			compatible = "shared-dma-pool";
			reusable;
			alloc-ranges = <0 0x80000000 0 0x40000000>;
			size = <0 0x10000000>;
			linux,cma-default;
		};

		ethosu_mem: ethosu_region@C0000000 {
			compatible = "shared-dma-pool";
			reusable;
			reg = <0x0 0xC0000000 0x0 0x10000000>;
		};

		/* EdgeLock Enclave reserved memory region */
		ele_reserved: ele-reserved@90000000 {
			compatible = "shared-dma-pool";
			reg = <0 0x90000000 0 0x100000>;
			no-map;
		};

		/* Cortex-M33 reserved memory regions */
		rsc_table: rsc-table@1fff8000 {
			reg = <0 0x1fff8000 0 0x1000>;
			no-map;
		};

		vdev0vring0: vdev0vring0@aff00000 {
			reg = <0 0xaff00000 0 0x8000>;
			no-map;
		};

		vdev0vring1: vdev0vring1@aff08000 {
			reg = <0 0xaff08000 0 0x8000>;
			no-map;
		};

		vdev1vring0: vdev1vring0@aff10000 {
			reg = <0 0xaff10000 0 0x8000>;
			no-map;
		};

		vdev1vring1: vdev1vring1@aff18000 {
			reg = <0 0xaff18000 0 0x8000>;
			no-map;
		};

		vdevbuffer: vdevbuffer@a8400000 {
			compatible = "shared-dma-pool";
			reg = <0 0xa8400000 0 0x100000>;
			no-map;
		};

		m33_reserved: m33_noncacheable_section@a8600000 {
			no-map;
			reg = <0 0xa8600000 0 0x1000000>;
		};
	};

	/* WiFi SDIO power sequence */
	wifi_pwrseq: wifi-pwrseq {
		compatible = "mmc-pwrseq-simple";
		pinctrl-names = "default";
		reset-gpios = <&gpio4 26 GPIO_ACTIVE_LOW>; /* WLAN_RST */
		post-power-on-delay-ms = <500>; /* Increased for proper reset */
		power-off-delay-us = <50000>; /* Increased to 50ms for proper reset */
	};

	/* Regulators */
	reg_wifi_vmmc: regulator-wifi-vmmc {
		compatible = "regulator-fixed";
		regulator-name = "VSD_3V3";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		/* WiFi power is controlled by MCXC143VFM, not directly by i.MX93 GPIO */
		regulator-always-on;
		startup-delay-us = <100>;
	};

	/* E-Ink Display Power Regulator */
	reg_eink_vdd: regulator-eink-vdd {
		compatible = "regulator-fixed";
		regulator-name = "EINK_VDD";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		gpio = <&gpio2 11 GPIO_ACTIVE_HIGH>; /* E-Ink power enable - GPIO2_11 */
		enable-active-high;
		startup-delay-us = <1000>;
		regulator-boot-on;
	};

};

/* Cortex-M33 support enabled for E-Ink board */
&cm33 {
	mbox-names = "tx", "rx", "rxdb";
	mboxes = <&mu1 0 1
		  &mu1 1 1
		  &mu1 3 1>;
	memory-region = <&vdevbuffer>, <&vdev0vring0>, <&vdev0vring1>, <&rsc_table>;
	status = "okay";
};

/* EdgeLock Enclave Message Unit - required for secure functionality */
&s4muap {
	status = "okay";
};

&mu1 {
	status = "okay";
};

&mu2 {
	status = "okay";
};

/* Console UART */
&lpuart1 {
	status = "okay";
};

/* Pin configuration for LPUART5 Bluetooth */
&iomuxc {
	pinctrl_lpuart5: lpuart5grp {
		fsl,pins = <
			MX93_PAD_DAP_TDO_TRACESWO__LPUART5_TX	0x31e  /* BT UART RX - Output from iMX93 */
			MX93_PAD_DAP_TDI__LPUART5_RX		0x31e  /* BT UART TX - Input to iMX93 */
			MX93_PAD_DAP_TCLK_SWCLK__LPUART5_CTS_B	0x31e  /* BT UART CTS - Output from iMX93 */
			MX93_PAD_DAP_TMS_SWDIO__LPUART5_RTS_B	0x31e  /* BT UART RTS - Input to iMX93 */
		>;
	};

	pinctrl_bluetooth_gpio: bluetooth_gpio_grp {
		fsl,pins = <
			MX93_PAD_ENET2_RD0__GPIO4_IO24		0x31e  /* BT_RST - Active Low, controlled by MCXC143VFM */
		>;
	};

	/* FlexSPI1 (QSPI) pin configuration for E-Ink display - Primary Option */
	pinctrl_flexspi1: flexspi1grp {
		fsl,pins = <
			MX93_PAD_SD3_CLK__FLEXSPI1_A_SCLK	0x31e  /* QSPI Clock */
			MX93_PAD_SD3_CMD__FLEXSPI1_A_SS0_B	0x31e  /* QSPI CS0 */
			MX93_PAD_SD3_DATA0__FLEXSPI1_A_DATA00	0x31e  /* QSPI Data 0 */
			MX93_PAD_SD3_DATA1__FLEXSPI1_A_DATA01	0x31e  /* QSPI Data 1 */
			MX93_PAD_SD3_DATA2__FLEXSPI1_A_DATA02	0x31e  /* QSPI Data 2 */
			MX93_PAD_SD3_DATA3__FLEXSPI1_A_DATA03	0x31e  /* QSPI Data 3 */
		>;
	};

	/* SPI1 pin configuration for E-Ink display - Backup Option */
	pinctrl_lpspi1: lpspi1grp {
		fsl,pins = <
			MX93_PAD_SAI1_TXC__LPSPI1_SIN		0x31e  /* MISO */
			MX93_PAD_SAI1_RXD0__LPSPI1_SOUT		0x31e  /* MOSI */
			MX93_PAD_SAI1_TXD0__LPSPI1_SCK		0x31e  /* SCK */
			MX93_PAD_SAI1_TXFS__LPSPI1_PCS0		0x31e  /* CS0 */
		>;
	};

	/* SPI3 pin configuration for 802.15.4 - ublox MAYA W2 module */
	pinctrl_lpspi3: lpspi3grp {
		fsl,pins = <
			MX93_PAD_GPIO_IO09__LPSPI3_SIN		0x31e  /* MOSI - SPI3_MOSI */
			MX93_PAD_GPIO_IO10__LPSPI3_SOUT		0x31e  /* MISO - SPI3_MISO */
			MX93_PAD_GPIO_IO11__LPSPI3_SCK		0x31e  /* SCK - SPI3_SCLK */
			MX93_PAD_GPIO_IO08__LPSPI3_PCS0		0x31e  /* CS0 - SPI3_SS0 */
			MX93_PAD_ENET2_RD3__GPIO4_IO27		0x31e  /* ZB_INT - 802.15.4 Interrupt */
		>;
	};

	/* E-Ink display GPIO pins */
	pinctrl_eink_gpio: eink_gpio_grp {
		fsl,pins = <
			MX93_PAD_GPIO_IO14__GPIO2_IO14		0x31e  /* RES_DIS# - Reset (Active-Low) */
			MX93_PAD_GPIO_IO15__GPIO2_IO15		0x31e  /* D/C#_DIS - Data/Command (LO=Cmd, HI=Data) */
			MX93_PAD_GPIO_IO16__GPIO2_IO16		0x31e  /* L#R_SEL_DIS - Left/Right Select (LO=Left, HI=Right) */
			MX93_PAD_GPIO_IO17__GPIO2_IO17		0x31e  /* BUSY_DIS# - Busy Status (LO=Busy, Input) */
		>;
	};
};

/* Bluetooth UART - ublox MAYA W2 - LPUART5 */
&lpuart5 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpuart5>;
	fsl,uart-has-rtscts;
	status = "okay";

	bluetooth {
		compatible = "nxp,88w8997-bt";
		fw-init-baudrate = <3000000>;
	};
};

/* WiFi SDIO Interface - ublox MAYA W2 (IW612) */
&usdhc2 {
	vmmc-supply = <&reg_wifi_vmmc>;
	mmc-pwrseq = <&wifi_pwrseq>;
	bus-width = <4>;
	keep-power-in-suspend;
	non-removable;
	wakeup-source;
	max-frequency = <100000000>;
	fsl,sdio-async-interrupt-enabled;
	pm-ignore-notify;
	cap-power-off-card;
	status = "okay";

	wifi_wake_host {
		compatible = "nxp,wifi-wake-host";
		interrupt-parent = <&gpio4>;
		interrupts = <25 IRQ_TYPE_LEVEL_LOW>;  /* ENET2_RD1 - SD2_INT */
		interrupt-names = "host-wake";
		wakeup-source;
	};
};

/* eMMC storage */
&usdhc1 {
	bus-width = <8>;
	non-removable;
	keep-power-in-suspend;
	status = "okay";
};

/*
 * E-Ink Display SPI Configuration - Spectra 6 EL133UF1
 * 
 * Both QSPI and regular SPI interfaces are enabled by default for maximum flexibility:
 * 
 * FlexSPI1 (QSPI) - Primary Option:
 *   - Device: /dev/spidev0.0
 *   - Speed: Up to 80 MHz
 *   - 4-bit data width (quad mode)
 *   - Uses SD3 pins (SD3_CLK, SD3_CMD, SD3_DATA0-3)
 *   - Compatible: "spectra6,el133uf1-qspi", "spidev" (fallback for testing)
 * 
 * LPSPI1 (Regular SPI) - Backup/Alternative Option:
 *   - Device: /dev/spidev1.0  
 *   - Speed: Up to 10 MHz (conservative)
 *   - 1-bit data width (standard SPI)
 *   - Uses SAI1 pins (SAI1_TXC, SAI1_RXD0, SAI1_TXD0, SAI1_TXFS)
 *   - Compatible: "spectra6,el133uf1-spi", "spidev" (fallback for testing)
 * 
 * Both interfaces share the same GPIO control pins (reset, busy, dc) and power supply.
 * The spidev fallback compatible string enables /dev/spidev* devices for testing
 * and development while preserving the ability to load custom E-Ink drivers.
 */

/* QSPI Interface for E-Ink Display - DISABLED (FlexSPI doesn't support spidev) */
&flexspi1 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_flexspi1>;
	status = "disabled"; /* FlexSPI uses MTD subsystem, not spidev */

	eink_display: flash@0 {
		compatible = "rohm,dh2228fv";
		reg = <0>;
		spi-max-frequency = <80000000>; /* 80 MHz - QSPI can handle higher speeds */
		spi-tx-bus-width = <4>; /* Quad SPI - 4 data lines for TX */
		spi-rx-bus-width = <4>; /* Quad SPI - 4 data lines for RX */
		
		/* GPIO control pins for E-Ink display - pinctrl only (allows userspace access) */
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_eink_gpio>;
		
		/* Power supply for E-Ink display */
		vdd-supply = <&reg_eink_vdd>;
		
		status = "disabled"; /* FlexSPI uses MTD subsystem, not spidev */
	};
};

/* Standard SPI Interface for E-Ink Display - PRIMARY for testing */
&lpspi1 {
	#address-cells = <1>;
	#size-cells = <0>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpspi1>;
	status = "okay"; /* Primary interface for standard SPI testing */

	eink_display_spi: eink@0 {
		compatible = "rohm,dh2228fv";
		reg = <0>;
		spi-max-frequency = <10000000>; /* 10 MHz - conservative for regular SPI */
		spi-cpha;
		spi-cpol;
		
		/* GPIO control pins for E-Ink display - pinctrl only (allows userspace access) */
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_eink_gpio>;
		
		/* Power supply for E-Ink display */
		vdd-supply = <&reg_eink_vdd>;
		
		status = "okay";
	};
};

/*
 * 802.15.4 SPI Interface - ublox MAYA W2 module (IW612 chipset)
 * 
 * LPSPI3 Configuration:
 *   - Device: /dev/spidev2.0
 *   - Speed: Up to 12 MHz
 *   - Standard SPI mode
 *   - Uses GPIO pins (GPIO_IO08-11) for SPI signals
 *   - Interrupt: GPIO4_IO27 (ENET2_RD3)
 *   - Reset: Shared with Bluetooth (GPIO4_IO24, controlled by MCXC143VFM)
 */
&lpspi3 {
	#address-cells = <1>;
	#size-cells = <0>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpspi3>;
	status = "okay";

	zigbee_802154: zigbee@0 {
		compatible = "rohm,dh2228fv";
		reg = <0>;
		spi-max-frequency = <12000000>; /* 12 MHz for 802.15.4 communication */
		
		/* Interrupt pin for 802.15.4 */
		interrupt-parent = <&gpio4>;
		interrupts = <27 IRQ_TYPE_LEVEL_LOW>; /* GPIO4_IO27 - ZB_INT */
		
		/* Reset is shared with Bluetooth, controlled by MCXC143VFM power controller */
		/* reset-gpios = <&gpio4 24 GPIO_ACTIVE_LOW>; // BT_RST - shared reset */
		
		status = "okay";
	};
};

&wdog3 {
	status = "okay";
	timeout-sec = <40>;
};
