#!/bin/sh
# USB Composite Gadget Setup Script for imx8mm-jaguar-sentai
# Creates a single USB composite gadget with both CDC Serial and UAC2 Audio functions
# This solves the UDC binding conflict between separate gadgets
#
# Usage: setup-usb-composite-gadget {setup|stop|status|restart}
# Prerequisites: USB port in device mode, ConfigFS mounted
#
# Author: Alex J Lennon <ajlennon@dynamicdevices.co.uk>

CONFIGFS=/sys/kernel/config/usb_gadget
GADGET_NAME="g_composite"
GADGET=$CONFIGFS/$GADGET_NAME
CONFIG=$GADGET/configs/c.1
FUNCTIONS=$GADGET/functions

# USB Device Descriptor
VID="0x1d6b"  # Linux Foundation
PID="0x0104"  # Multifunction Composite Gadget
SERIALNUMBER="$(cat /proc/sys/kernel/random/uuid 2>/dev/null || echo '0123456789')"
MANUFACTURER="Dynamic Devices Ltd"
PRODUCT="Jaguar Sentai USB Composite Device"

# Audio Configuration
SAMPLE_RATE=48000
SAMPLE_SIZE=2  # 16-bit (2 bytes)
CHANNELS=2     # Stereo
STEREO_CHMASK=3  # 3 = Front Left (1) + Front Right (2) for stereo

# Function to add CDC ACM function
add_acm_function() {
    function_name="$1"
    
    mkdir "$FUNCTIONS/acm.$function_name" || echo "  Couldn't create $FUNCTIONS/acm.$function_name"
    ln -s "$FUNCTIONS/acm.$function_name" "$CONFIG" || echo "  Couldn't symlink acm.$function_name"
}

# Function to add UAC2 audio function
add_uac2_function() {
    function_name="$1"
    
    mkdir "$FUNCTIONS/uac2.$function_name" || echo "  Couldn't create $FUNCTIONS/uac2.$function_name"
    
    echo "$PRODUCT Audio" > "$FUNCTIONS/uac2.$function_name/function_name"
    echo $SAMPLE_RATE > "$FUNCTIONS/uac2.$function_name/c_srate"
    echo $SAMPLE_RATE > "$FUNCTIONS/uac2.$function_name/p_srate"
    echo $SAMPLE_SIZE > "$FUNCTIONS/uac2.$function_name/c_ssize"
    echo $SAMPLE_SIZE > "$FUNCTIONS/uac2.$function_name/p_ssize"
    
    # Set capture to adaptive (no feedback endpoint needed for IN direction)
    # Playback uses async (with feedback), capture uses adaptive (without feedback)
    echo "adaptive" > "$FUNCTIONS/uac2.$function_name/c_sync"
    
    echo "$STEREO_CHMASK" > "$FUNCTIONS/uac2.$function_name/c_chmask"
    echo "$STEREO_CHMASK" > "$FUNCTIONS/uac2.$function_name/p_chmask"
    
    # Enable volume and mute controls
    echo 0x1 > "$FUNCTIONS/uac2.$function_name/c_mute_present"
    echo 0x1 > "$FUNCTIONS/uac2.$function_name/c_volume_present"
    echo 0x1 > "$FUNCTIONS/uac2.$function_name/p_mute_present"
    echo 0x1 > "$FUNCTIONS/uac2.$function_name/p_volume_present"
    
    ln -s "$FUNCTIONS/uac2.$function_name" "$CONFIG" || echo "  Couldn't symlink uac2.$function_name"
}

# Function to create gadget configuration
create_config() {
    config_name="$1"
    
    # Check if ConfigFS is available
    if ! [ -e "$CONFIGFS" ]; then
        echo "  $CONFIGFS does not exist, skipping configfs usb gadget"
        return 1
    fi
    
    # Create USB gadget configuration
    mkdir "$GADGET" || echo "  Couldn't create $GADGET"
    echo $VID > "$GADGET/idVendor"
    echo $PID > "$GADGET/idProduct"
    
    mkdir "$GADGET/strings/0x409" || echo "  Couldn't create $GADGET/strings/0x409"
    echo "$SERIALNUMBER" > "$GADGET/strings/0x409/serialnumber"
    echo "$MANUFACTURER" > "$GADGET/strings/0x409/manufacturer"
    echo "$PRODUCT" > "$GADGET/strings/0x409/product"
    
    # Create configuration instance for the gadget
    mkdir "$CONFIG" || echo "  Couldn't create $CONFIG"
    mkdir "$CONFIG/strings/0x409" || echo "  Couldn't create $CONFIG/strings/0x409"
    echo "$config_name" > "$CONFIG/strings/0x409/configuration" || echo "  Couldn't write configuration name"
    
    # Set configuration attributes
    echo 0x80 > "$CONFIG/bmAttributes"  # Bus-powered
    echo 250 > "$CONFIG/MaxPower"       # 500mA max power
}

# Function to setup USB composite gadget
setup_gadget() {
    echo "Setting up USB Composite Gadget (CDC Serial + UAC2 Audio)..."
    
    # Create gadget configuration
    create_config "USB Composite Device"
    
    # Add CDC ACM function for serial communication
    add_acm_function "debug"
    
    # Add UAC2 audio functions
    # Note: Combining playback and capture in a single function with stereo channels
    add_uac2_function "audio"
    
    echo "USB Composite Gadget configured successfully!"
}

# Function to enable the gadget
enable_gadget() {
    # Check if there's a USB Device Controller
    if [ -z "$(ls /sys/class/udc 2>/dev/null)" ]; then
        echo "  No USB Device Controller available"
        return 1
    fi
    
    # Activate the gadget
    udc_device="$(find /sys/class/udc -maxdepth 1 -type l | head -1 | xargs basename 2>/dev/null)"
    echo "Enabling USB Composite Gadget on $udc_device..."
    echo "$udc_device" > "$GADGET/UDC" || echo "  Couldn't write UDC"
    
    # Configure the serial device for proper operation
    if [ -c /dev/ttyGS0 ]; then
        echo "Configuring /dev/ttyGS0 for serial communication..."
        stty -F /dev/ttyGS0 raw 2>/dev/null || echo "  Warning: Couldn't configure ttyGS0 (may not be ready yet)"
        stty -F /dev/ttyGS0 -echo 2>/dev/null || true
        stty -F /dev/ttyGS0 noflsh 2>/dev/null || true
        echo "USB CDC Serial device available at /dev/ttyGS0"
    else
        echo "Warning: /dev/ttyGS0 not yet available (may appear shortly)"
    fi
    
    echo "USB Composite Gadget enabled!"
    echo "Host computer should detect both CDC ACM serial device and USB Audio Class device."
}

# Function to disable the gadget
disable_gadget() {
    echo "Disabling USB Composite Gadget..."
    
    if [ -d "$GADGET" ]; then
        # Unbind from UDC first
        echo "" > "$GADGET/UDC" 2>/dev/null || true
        
        # Remove function symlinks from configuration
        rm -f "$CONFIG"/acm.* 2>/dev/null || true
        rm -f "$CONFIG"/uac2.* 2>/dev/null || true
        
        # Remove configuration
        rm -rf "$CONFIG/strings/0x409" 2>/dev/null || true
        rm -rf "$CONFIG" 2>/dev/null || true
        
        # Remove functions
        rm -rf "${FUNCTIONS:?}"/* 2>/dev/null || true
        
        # Remove strings and gadget
        rm -rf "$GADGET/strings/0x409" 2>/dev/null || true
        rm -rf "$GADGET" 2>/dev/null || true
        
        echo "USB Composite Gadget disabled!"
    else
        echo "USB Composite Gadget is not configured."
    fi
}

# Function to show status
show_status() {
    echo "USB Composite Gadget Status:"
    echo "============================"
    
    if [ -d "$GADGET" ]; then
        echo "Gadget: CONFIGURED"
        echo "UDC: $(cat "$GADGET/UDC" 2>/dev/null || echo 'Not bound')"
        echo "Vendor ID: 0x$(cat "$GADGET/idVendor" 2>/dev/null || echo 'N/A')"
        echo "Product ID: 0x$(cat "$GADGET/idProduct" 2>/dev/null || echo 'N/A')"
        echo "Manufacturer: $(cat "$GADGET/strings/0x409/manufacturer" 2>/dev/null || echo 'N/A')"
        echo "Product: $(cat "$GADGET/strings/0x409/product" 2>/dev/null || echo 'N/A')"
        
        echo ""
        echo "Functions:"
        for func in "$FUNCTIONS"/*; do
            if [ -d "$func" ]; then
                func_name="$(basename "$func")"
                echo "  $func_name: Available"
                
                # Show specific details for audio functions
                if echo "$func_name" | grep -q "uac2"; then
                    echo "    Sample Rate: $(cat "$func/p_srate" 2>/dev/null || echo 'N/A') Hz"
                    echo "    Playback Channels: $(cat "$func/p_chmask" 2>/dev/null || echo 'N/A')"
                    echo "    Capture Channels: $(cat "$func/c_chmask" 2>/dev/null || echo 'N/A')"
                fi
            fi
        done
        
        echo ""
        echo "Serial Device:"
        if [ -c /dev/ttyGS0 ]; then
            echo "  /dev/ttyGS0: Available"
            echo "  Device permissions: $(ls -l /dev/ttyGS0 | awk '{print $1 " " $3 " " $4}')"
        else
            echo "  /dev/ttyGS0: Not available"
        fi
    else
        echo "Gadget: NOT CONFIGURED"
    fi
    
    echo ""
    echo "Available UDC devices:"
    ls /sys/class/udc/ 2>/dev/null || echo "  None found"
    
    echo ""
    echo "USB Role Status:"
    for role_path in $(find /sys -name 'role' 2>/dev/null | head -3); do
        current_role=$(cat "$role_path" 2>/dev/null || echo 'unknown')
        echo "  $role_path: $current_role"
    done
    
    echo ""
    echo "UDC State:"
    for udc in /sys/class/udc/*; do
        if [ -d "$udc" ]; then
            udc_name=$(basename "$udc")
            state=$(cat "$udc/state" 2>/dev/null || echo 'unknown')
            echo "  $udc_name: $state"
        fi
    done
}

# Function to cleanup existing gadgets
cleanup_existing() {
    echo "Cleaning up existing USB gadgets..."
    
    # Disable existing gadgets
    for gadget_dir in "$CONFIGFS"/g_*; do
        if [ -d "$gadget_dir" ]; then
            gadget_name=$(basename "$gadget_dir")
            echo "  Disabling $gadget_name..."
            echo "" > "$gadget_dir/UDC" 2>/dev/null || true
        fi
    done
    
    # Give time for cleanup
    sleep 1
}

# Main script logic
case "$1" in
    "setup"|"start")
        cleanup_existing
        disable_gadget  # Clean up any existing composite configuration
        setup_gadget
        enable_gadget
        ;;
    "stop"|"disable")
        disable_gadget
        ;;
    "status")
        show_status
        ;;
    "restart")
        cleanup_existing
        disable_gadget
        setup_gadget
        enable_gadget
        ;;
    "cleanup")
        cleanup_existing
        disable_gadget
        ;;
    *)
        echo "Usage: $0 {setup|start|stop|disable|status|restart|cleanup}"
        echo ""
        echo "Commands:"
        echo "  setup/start  - Configure and enable USB composite gadget"
        echo "  stop/disable - Disable and remove USB composite gadget"
        echo "  status       - Show current gadget status"
        echo "  restart      - Disable and re-enable gadget"
        echo "  cleanup      - Clean up all existing gadgets"
        echo ""
        echo "This script creates a composite USB gadget with both:"
        echo "  - CDC ACM Serial interface (/dev/ttyGS0)"
        echo "  - USB Audio Class 2.0 (48kHz, 16-bit, stereo)"
        echo ""
        echo "Note: Make sure the USB port is in device mode before running setup."
        exit 1
        ;;
esac



