# ===== ALSA config for TAS2563 SmartAMP with AEC =====

# ---- TAS2563 SmartAMP Configuration ----
# The TAS2781 driver with TAS2563 codec supports regbin profiles and DSP modes
# Key controls:
#   - "Program": 0=DSP mode, 1=Bypass mode  
#   - "TASDEVICE Profile id": Regbin configuration (0-5+ depending on regbin file)
#   - "Configuration": DSP configuration when Program=0

# ---- Physical Speaker (used by pipeline as "spk") ----
pcm.spk {
    type hw
    card tas2563audio
    device 0
}
ctl.spk { type hw card tas2563audio }

pcm.!default {
    type plug
    slave.pcm "spk"
}

ctl.!default { type hw card tas2563audio }

# ---- Physical Microphone (used by pipeline as "mic") ----
# --- Keep your existing hardware mic alias ---
pcm.mic {
    type hw
    card micfilaudio
    device 0
    channels 2
}
ctl.mic { type hw card micfilaudio }

# ---- Loopback pair 0: Azure TTS -> AEC probe ----
pcm.loop_playback_far {  # write here from Azure TTS
    type hw
    card Loopback
    device 0
    subdevice 0
}

pcm.loop_capture_far {   # read here for webrtcechoprobe
    type hw
    card Loopback
    device 1
    subdevice 0
}

# ---- Loopback pair 1: AEC output -> consumers (e.g., STT) ----
pcm.loop_playback_near {  # AEC writes cleaned audio here
    type hw
    card Loopback
    device 0
    subdevice 1
}
pcm.loop_capture_near {   # single-open reader of cleaned audio
    type hw
    card Loopback
    device 1
    subdevice 1
}

# wakeword
pcm.loop_playback_near_wake { type hw; card Loopback; device 0; subdevice 2 }
pcm.loop_capture_near_wake  { type hw; card Loopback; device 1; subdevice 2 }

# stopword
pcm.loop_playback_near_stop { type hw; card Loopback; device 0; subdevice 3 }
pcm.loop_capture_near_stop  { type hw; card Loopback; device 1; subdevice 3 }

# barge-in
pcm.loop_playback_near_barge { type hw; card Loopback; device 0; subdevice 4 }
pcm.loop_capture_near_barge  { type hw; card Loopback; device 1; subdevice 4 }

# recording
pcm.loop_playback_near_rec { type hw; card Loopback; device 0; subdevice 5 }
pcm.loop_capture_near_rec  { type hw; card Loopback; device 1; subdevice 5 }



# ===== Echo Reference from TAS2563 (Profile 8 - Echo Removal Mode) =====
# Hardware capture endpoint for TAS2563 echo reference output
# Profile 8 provides echo reference in slot 3 for AEC processing
# This captures the actual speaker output for echo cancellation
pcm.eref_hw {
    type hw
    card tas2563audio # TAS2563 card with bidirectional audio
    device 0          # Main audio device
    subdevice 1       # Capture subdevice for echo reference
}

ctl.eref_hw { type hw card tas2563audio }

# Allow multiple readers and stable 10-ms cadence from the hardware
pcm.eref_dsnoop {
    type dsnoop
    ipc_key 8473
    ipc_key_add_uid true
    ipc_perm 0666
    slave {
        pcm "eref_hw"
        channels 1
        rate 48000
        format S32_LE       # Match Profile 8's 32-bit format
        period_size 480     # 10 ms @ 48 kHz
        buffer_size 1920    # 40 ms buffer
    }
}

# Final EchoRef alias: always present as mono, S32_LE @ 48 kHz (Profile 8 format)
pcm.eref {
    type plug
    slave {
        pcm "eref_dsnoop"
        rate 48000
        format S32_LE       # Native Profile 8 format
        channels 1
    }
}

# Legacy S16_LE alias for compatibility with existing AEC code
pcm.eref_16bit {
    type plug
    slave {
        pcm "eref_dsnoop"
        rate 48000
        format S16_LE       # Converted to 16-bit for legacy compatibility
        channels 1
    }
}
ctl.eref { type hw card tas2563audio }

# ===== TAS2563 Profile Management =====
# Based on regbin analysis, the TAS2563 supports these key profiles:
# Profile 0: Music 16-bit 16kHz 4-slot
# Profile 1: Calibration auto-rate 16-bit  
# Profile 2: Calibration 16kHz 16-bit 4-slot
# Profile 3: Speaker bypass 16kHz 4-slot (electrical test)
# Profile 4: Bypass auto-rate 16-bit L+R
# Profile 5: Music 16-bit auto-rate I2S
# Profile 6: Bypass auto-rate 16-bit L
# Profile 7: Bypass auto-rate 16-bit R
# Profile 8: PDM recording I2S 48kHz 32-bit TX-slot-0-1 mic-slot-3 ref (ECHO REMOVAL)
# Profile 9: Auto-rate 32-bit
# Profile 10: Bypass auto-rate 32-bit
#
# DEFAULT: Profile 8 (Echo Removal) - PDM recording with echo reference
#   amixer -c tas2563audio cset name="Program" 0              # Enable DSP mode
#   amixer -c tas2563audio cset name="TASDEVICE Profile id" 8 # Echo removal profile
#   amixer -c tas2563audio cset name="Configuration" 0        # Select DSP config 0
#
# Alternative profiles:
#   tas2563-init echo-removal  # Profile 8 (default)
#   tas2563-init music         # Profile 5 (I2S music)
#   tas2563-init bypass        # Profile 3 (bypass test)
#
# ===== Echo Reference Access (Profile 8) =====
# When using Profile 8 (echo-removal), the TAS2563 provides echo reference via:
# - Playback: hw:tas2563audio,0,0 (speaker output to slots 0-1)
# - Capture: hw:tas2563audio,0,1 (echo reference from slot 3)
# 
# Test echo reference capture:
#   arecord -D hw:tas2563audio,0,1 -f S32_LE -r 48000 -c 1 echo_ref_test.wav
#   arecord -D eref -f S32_LE -r 48000 -c 1 echo_ref_via_alias.wav
#   arecord -D eref_16bit -f S16_LE -r 48000 -c 1 echo_ref_16bit.wav
#
# Use in AEC pipeline:
#   - Speaker audio → TAS2563 slots 0-1 → Physical speakers  
#   - Echo reference ← TAS2563 slot 3 ← Echo cancellation processing
#   - Microphone input via existing micfil or TAS2563 PDM (if enabled)
#
# IMPORTANT: Capture subdevice may vary by driver implementation
# If hw:tas2563audio,0,1 doesn't work, try:
#   - hw:tas2563audio,1,0 (separate capture device)
#   - Check with: arecord -l | grep tas2563audio
