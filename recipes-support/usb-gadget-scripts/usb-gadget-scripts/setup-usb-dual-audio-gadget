#!/bin/sh
# USB Dual Audio Gadget Setup Script for imx8mm-jaguar-dt510
# Creates two UAC2 audio functions for bus audio:
#   - Driver: bidirectional (output to driver, input from driver)
#   - Passengers: output to passengers
# Uses UAC2 (available in LMP kernel). Host sees one USB device with two audio interfaces.
#
# Usage: setup-usb-dual-audio-gadget {setup|stop|status|restart}

CONFIGFS=/sys/kernel/config/usb_gadget
GADGET_NAME="g_dual_audio"

# Ensure libcomposite is loaded (creates usb_gadget in configfs)
modprobe libcomposite 2>/dev/null || true
GADGET=$CONFIGFS/$GADGET_NAME
CONFIG=$GADGET/configs/c.1
FUNCTIONS=$GADGET/functions

# USB Device Descriptor
VID="0x1d6b"  # Linux Foundation
PID="0x0105"  # Different PID to distinguish from single-audio gadget
SERIALNUMBER="$(cat /sys/devices/soc0/serial_number 2>/dev/null || cat /etc/machine-id 2>/dev/null || echo 'DD-DT510-UNKNOWN')"
MANUFACTURER="Dynamic Devices Ltd"
PRODUCT="Jaguar DT510 Dual Audio Device"

# Audio Configuration
SAMPLE_RATE=16000
SAMPLE_SIZE=2  # 16-bit (2 bytes)
CHANNELS=2     # Stereo (chmask 3)

# Function to add CDC ACM function
add_acm_function() {
    function_name="$1"

    mkdir "$FUNCTIONS/acm.$function_name" || echo "  Couldn't create $FUNCTIONS/acm.$function_name"
    ln -s "$FUNCTIONS/acm.$function_name" "$CONFIG" || echo "  Couldn't symlink acm.$function_name"
}

# Function to add UAC2 audio function (for capture/playback)
# $1 = instance id (configfs dir, e.g. driver)
# $2 = display name (USB/ALSA string, e.g. Driver)
add_uac2_function() {
    instance_id="$1"
    display_name="$2"

    mkdir "$FUNCTIONS/uac2.$instance_id" || echo "  Couldn't create $FUNCTIONS/uac2.$instance_id"

    echo "$PRODUCT $display_name" > "$FUNCTIONS/uac2.$instance_id/function_name"
    echo $SAMPLE_RATE > "$FUNCTIONS/uac2.$instance_id/c_srate"
    echo $SAMPLE_RATE > "$FUNCTIONS/uac2.$instance_id/p_srate"
    echo $SAMPLE_SIZE > "$FUNCTIONS/uac2.$instance_id/c_ssize"
    echo $SAMPLE_SIZE > "$FUNCTIONS/uac2.$instance_id/p_ssize"
    # Use adaptive sync (no feedback endpoint) to fit 2x UAC2 + ACM within endpoint limit
    echo "adaptive" > "$FUNCTIONS/uac2.$instance_id/c_sync"
    echo $CHANNELS > "$FUNCTIONS/uac2.$instance_id/c_chmask"
    echo $CHANNELS > "$FUNCTIONS/uac2.$instance_id/p_chmask"
    echo 1 > "$FUNCTIONS/uac2.$instance_id/c_hs_bint" 2>/dev/null || true
    echo 1 > "$FUNCTIONS/uac2.$instance_id/p_hs_bint" 2>/dev/null || true
    echo 4 > "$FUNCTIONS/uac2.$instance_id/req_number" 2>/dev/null || true

    ln -s "$FUNCTIONS/uac2.$instance_id" "$CONFIG" || echo "  Couldn't symlink uac2.$instance_id"
}

# Function to create gadget configuration
create_config() {
    config_name="$1"

    # Check if ConfigFS is available
    if ! [ -e "$CONFIGFS" ]; then
        echo "  $CONFIGFS does not exist, skipping configfs usb gadget"
        return 1
    fi

    # Create USB gadget configuration
    mkdir "$GADGET" || echo "  Couldn't create $GADGET"
    echo $VID > "$GADGET/idVendor"
    echo $PID > "$GADGET/idProduct"

    mkdir "$GADGET/strings/0x409" || echo "  Couldn't create $GADGET/strings/0x409"
    echo "$SERIALNUMBER" > "$GADGET/strings/0x409/serialnumber"
    echo "$MANUFACTURER" > "$GADGET/strings/0x409/manufacturer"
    echo "$PRODUCT" > "$GADGET/strings/0x409/product"

    # Create configuration instance for the gadget
    mkdir "$CONFIG" || echo "  Couldn't create $CONFIG"
    mkdir "$CONFIG/strings/0x409" || echo "  Couldn't create $CONFIG/strings/0x409"
    echo "$config_name" > "$CONFIG/strings/0x409/configuration" || echo "  Couldn't write configuration name"

    # Set configuration attributes
    echo 0x80 > "$CONFIG/bmAttributes"  # Bus-powered
    echo 250 > "$CONFIG/MaxPower"       # 500mA max power
}

# Function to setup USB dual audio gadget
setup_gadget() {
    echo "Setting up USB Dual Audio Gadget for DT510 (CDC Serial + 2x UAC2 Audio)..."

    # Create gadget configuration
    create_config "USB Dual Audio Device"

    # Add CDC ACM function for serial communication
    add_acm_function "debug"

    # Add two UAC2 audio functions: Driver (bidirectional) and Passengers (output)
    add_uac2_function "driver" "Driver"
    add_uac2_function "passengers" "Passengers"

    echo "USB Dual Audio Gadget configured successfully!"
}

# Function to enable the gadget
enable_gadget() {
    # Check if there's a USB Device Controller
    if [ -z "$(ls /sys/class/udc 2>/dev/null)" ]; then
        echo "  No USB Device Controller available"
        return 1
    fi

    # Activate the gadget
    udc_device="$(find /sys/class/udc -maxdepth 1 -type l | head -1 | xargs basename 2>/dev/null)"
    echo "Enabling USB Dual Audio Gadget on $udc_device..."
    echo "$udc_device" > "$GADGET/UDC" || echo "  Couldn't write UDC"

    echo "USB Dual Audio Gadget enabled!"
    echo "Host will see: Driver (bidirectional), Passengers (output) - run arecord -l / aplay -l on host"
}

# Function to disable the gadget
disable_gadget() {
    echo "Disabling USB Dual Audio Gadget..."

    if [ -d "$GADGET" ]; then
        # Unbind from UDC first
        echo "" > "$GADGET/UDC" 2>/dev/null || true

        # Remove function symlinks from configuration
        rm -f "$CONFIG"/acm.* 2>/dev/null || true
        rm -f "$CONFIG"/uac2.* 2>/dev/null || true

        # Remove configuration
        rm -rf "$CONFIG/strings/0x409" 2>/dev/null || true
        rm -rf "$CONFIG" 2>/dev/null || true

        # Remove functions
        rm -rf "${FUNCTIONS:?}"/* 2>/dev/null || true

        # Remove strings and gadget
        rm -rf "$GADGET/strings/0x409" 2>/dev/null || true
        rm -rf "$GADGET" 2>/dev/null || true

        echo "USB Dual Audio Gadget disabled!"
    else
        echo "USB Dual Audio Gadget is not configured."
    fi
}

# Function to show status
show_status() {
    echo "USB Dual Audio Gadget Status (DT510):"
    echo "====================================="

    if [ -d "$GADGET" ]; then
        echo "Gadget: CONFIGURED (2x UAC2)"
        echo "UDC: $(cat "$GADGET/UDC" 2>/dev/null || echo 'Not bound')"

        echo ""
        echo "Functions:"
        for func in "$FUNCTIONS"/*; do
            if [ -d "$func" ]; then
                func_name="$(basename "$func")"
                echo "  $func_name: Available"

                # Show specific details for audio functions
                if echo "$func_name" | grep -q "uac2"; then
                    echo "    Sample Rate: $(cat "$func/p_srate" 2>/dev/null || echo 'N/A') Hz"
                    echo "    Channels: $(cat "$func/p_chmask" 2>/dev/null || echo 'N/A')"
                fi
            fi
        done
    else
        echo "Gadget: NOT CONFIGURED"
    fi
}

# Function to cleanup existing gadgets
cleanup_existing() {
    echo "Cleaning up existing USB gadgets..."

    # Disable existing gadgets
    for gadget_dir in "$CONFIGFS"/g_*; do
        if [ -d "$gadget_dir" ]; then
            gadget_name=$(basename "$gadget_dir")
            echo "  Disabling $gadget_name..."
            echo "" > "$gadget_dir/UDC" 2>/dev/null || true
        fi
    done

    sleep 1
}

# Main script logic
case "$1" in
    "setup"|"start")
        cleanup_existing
        disable_gadget
        setup_gadget
        enable_gadget
        ;;
    "stop"|"disable")
        disable_gadget
        ;;
    "status")
        show_status
        ;;
    "restart")
        cleanup_existing
        disable_gadget
        setup_gadget
        enable_gadget
        ;;
    *)
        echo "Usage: $0 {setup|start|stop|disable|status|restart}"
        echo ""
        echo "DT510-specific: Creates USB gadget with two UAC2 audio interfaces."
        echo "  - CDC ACM Serial (/dev/ttyGS0)"
        echo "  - Driver: bidirectional (output to driver, input from driver)"
        echo "  - Passengers: output to passengers"
        echo ""
        echo "Host sees one USB device with Driver and Passengers audio interfaces."
        exit 1
        ;;
esac
