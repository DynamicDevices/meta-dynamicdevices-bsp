#@TYPE: Machine
#@NAME: Dynamic Devices i.MX93 Jaguar E-Ink board with LPDDR4X
#@SOC: i.MX93
#@DESCRIPTION: Machine configuration for Dynamic Devices i.MX93 Jaguar E-Ink board with LPDDR4
#@MAINTAINER: Alex J Lennon  <ajlennon@dynamicdevices.co.uk>

MACHINEOVERRIDES =. "imx93-11x11-lpddr4x-evk:"

require conf/machine/imx93-11x11-lpddr4x-evk.conf
require conf/machine/include/mcumgr.inc

KMACHINE = "imx93-11x11-lpddr4x-evk"

KERNEL_MODULE_AUTOLOAD:imx93-jaguar-eink = " spidev"

MACHINE_FEATURES:remove:imx93-jaguar-eink = " nxp8987-sdio"

# IW612 chipset support for ublox MAYA W2 module (WiFi/BT only - no 802.15.4 on this board)
MACHINE_FEATURES:append:imx93-jaguar-eink = " nxpiw612-sdio wifi bluetooth"

# OP-TEE support - REQUIRED for imx93 SoCs (including mfgtool builds)
MACHINE_FEATURES:append:imx93-jaguar-eink = " optee"

# E-Ink display support - Spectra 6 EL133UF1 13.3" display
# TEMPORARILY DISABLED: eink-spectra6 recipe patch failure (Build 2034)
# MACHINE_FEATURES:append:imx93-jaguar-eink = " el133uf1"

# MCXC444 microcontroller support for power management
# Enables MCUboot bootloader and Zephyr RTOS firmware
# TEMPORARILY DISABLED: Causes U-Boot SPL size overflow (see GitHub issue #22)
# MACHINE_FEATURES:append:imx93-jaguar-eink = " mcuboot"

# MCUmgr support for managing the MCXC143VFM power controller
# Enables command-line tool for firmware updates and device management
MACHINE_FEATURES:append:imx93-jaguar-eink = " mcumgr"

# NXP WiFi firmware: Use secured firmware for imx93 with AHAB secure boot
# imx93-jaguar-eink uses AHAB secure boot, so use .se firmware files
# NXP_WIFI_INSECURE_FIRMWARE = "1"  # Disabled for secure boot

#SKIP_RECIPE[linux-firmware] = "linux-firmware is blacklisted"

# NOTE: This is *not* used for the lmp DISTRO / CI. This is just included for local development with lmp-base
KERNEL_DEVICETREE:append:imx93-jaguar-eink = " imx93-jaguar-eink.dtb"

# Fix imx-vpu-hantro build failure
TOOLCHAIN:pn-imx-vpu-hantro = "gcc"
TOOLCHAIN:pn-imx-vpu-hantro-daemon = "gcc"

# Fix nxp-afe* build failure
TOOLCHAIN:pn-nxp-afe = "gcc"
TOOLCHAIN:pn-nxp-afe-voiceseeker = "gcc"

# Need to have a non-default SPI buffer for optimal SPI communication
KERNEL_MODULE_PROBECONF:append:imx93-jaguar-eink = " spidev moal"
module_conf_spidev = "options spidev bufsiz=16384"

# WiFi firmware configuration for MOAL module
# Note: Module parameters work properly for loadable modules (CONFIG_MOAL=m)
# Using secured firmware (.se) as that's what's available on the target
module_conf_moal = "options moal fw_name=nxp/sduart_nw61x_v1.bin.se drvdbg=0"

# E-ink board specific: Remove audio/camera/graphics features, focus on wireless connectivity
# E-Ink displays don't need interactive GUI frameworks or hardware acceleration
MACHINE_FEATURES:remove:imx93-jaguar-eink = " alsa gpu gpu2d gpu3d opencl openvx"

SERIAL_CONSOLES = "115200:ttyUSBConsole"

# === Fast Boot Optimizations ===

# === Power Optimization for 5-Year Battery Life ===
# Priority: Power efficiency over performance for maximum battery life
# NOTE: EdgeLock Enclave enabled for secure functionality
OSTREE_KERNEL_ARGS:imx93-jaguar-eink ?= "console=ttyLP0,115200 rootfstype=ext4 loglevel=1 rw rootwait quiet fastboot initcall_debug=0 nohz=on rcu_nocbs=0-3 isolcpus=nohz,domain,managed_irq,0-3 cpufreq.default_governor=powersave rootflags=noatime,commit=60 kernel.kptr_restrict=1 kernel.dmesg_restrict=1"

# Load essential modules for E-Ink workflow optimization
# WiFi modules loaded automatically for immediate network availability
KERNEL_MODULE_AUTOLOAD:imx93-jaguar-eink = " spidev mlan moal"

# Workflow optimization: WiFi priority, delayed non-essential components
# WiFi built-in for immediate image update capability

# E-Ink display userspace software - handled via machine feature
# MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " eink-spectra6"

# Ensure unsecured IW612 WiFi firmware is installed for current unsecured build
MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " firmware-nxp-wifi-nxpiw612-sdio"

# Power optimization packages for 5-year battery life
MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " wifi-power-management filesystem-optimizations service-optimizations"

# MCXC143VFM power microcontroller setup - configures /dev/ttyLP2 connection on first boot
MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " mcxc143-setup"

# E-ink power management CLI tool for MCXC143VFM control
MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " eink-power-cli"

# Deep Sleep Mode (DSM) power management - 7.6mW standby power
MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " eink-power-management"

# EdgeLock Enclave (ELE) Security Support
# Provides secure boot, key management, and cryptographic services
MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " firmware-ele-imx"
# TEMPORARILY DISABLED: nxp-ele-dev-tools - debugging recipe resolution issue
# MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " nxp-ele-dev-tools"

# ELE-based Foundries.io LMP Integration
# Provides ELE-based device registration and OTA provisioning
MACHINE_EXTRA_RDEPENDS:append:imx93-jaguar-eink = " lmp-ele-foundries"

# Boot time optimizations
OSTREE_BOOTLOADER_EXTRA_CONFIG:imx93-jaguar-eink = "bootdelay=1"
