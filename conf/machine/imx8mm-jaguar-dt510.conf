#@TYPE: Machine
#@NAME: Dynamic Devices i.MX 8M Mini Jaguar DT510 board with LPDDR4
#@SOC: i.MX8MM
#@DESCRIPTION: Machine configuration for Dynamic Devices i.MX 8M Mini Jaguar DT510 board with LPDDR4
#@MAINTAINER: Alex J Lennon  <ajlennon@dynamicdevices.co.uk>

MACHINEOVERRIDES =. "imx8mm-lpddr4-evk:"

require conf/machine/imx8mm-lpddr4-evk.conf
require conf/machine/include/tas2562.inc

KMACHINE = "imx8mmevk"
KERNEL_MODULE_AUTOLOAD:imx8mm-jaguar-dt510 = " i2c-dev leds-lp50xx spidev snd-aloop"

MACHINE_FEATURES:remove:imx8mm-jaguar-dt510 = " nxp8987-sdio"

# Need to remove nxpiw612 to build SDK as for some reason it errors with a conflict with linux-firmware
# TODO: DT510 will use ublox MAYA-W2 WiFi module (IW612 chipset) - same as eink board
# For now using sentai WiFi configuration for demo purposes only - will be updated when new hardware arrives
MACHINE_FEATURES:append:imx8mm-jaguar-dt510 = " nxpiw612-sdio zigbee tas2562"

#SKIP_RECIPE[linux-firmware] = "linux-firmware is blacklisted"

# NOTE: This is *not* used for the lmp DISTRO / CI. This is just included for local development with lmp-base
KERNEL_DEVICETREE:append:imx8mm-jaguar-dt510 = " imx8mm-jaguar-dt510.dtb"

# Fix imx-vpu-hantro build failure
TOOLCHAIN:pn-imx-vpu-hantro = "gcc"
TOOLCHAIN:pn-imx-vpu-hantro-daemon = "gcc"

# Fix nxp-afe* build failure
TOOLCHAIN:pn-nxp-afe = "gcc"
TOOLCHAIN:pn-nxp-afe-voiceseeker = "gcc"

# Need to have a larger SPI buffer for SPINEL protocol (Zigbee/OpenThread)
KERNEL_MODULE_PROBECONF:append:imx8mm-jaguar-dt510 = "spidev"
module_conf_spidev = "options spidev bufsiz=32768"

# USB Gadget support - disabled to prevent automatic startup
# MACHINE_EXTRA_RDEPENDS:append:imx8mm-jaguar-dt510 = " usb-composite-gadget"

# Secure boot SE050 into OpTee (disabled for local development builds)
MACHINE_FEATURES:append:imx8mm-jaguar-dt510 = "${@'' if d.getVar('LOCAL_DEVELOPMENT_BUILD') == '1' else ' se05x'}"
# TODO: This line doesn't appear to take effect so overriding it in the OpTee recipe for now
SE05X_OEFID:imx8mm-jaguar-dt510 = "0xA200"

SERIAL_CONSOLES = "115200:ttyUSBConsole"